"""
Graphene Conductivity Model
===========================

Implementation of the Drude model for graphene intraband conductivity
in the terahertz frequency range.

Reference:
    Falkovsky, L. A. (2008). Optical properties of graphene.
    Journal of Physics: Conference Series, 129, 012004.
"""

import numpy as np

# Physical constants
E_CHARGE = 1.602176634e-19      # Electron charge [C]
HBAR = 1.054571817e-34          # Reduced Planck constant [J·s]
EV_TO_JOULE = 1.602176634e-19   # eV to Joule conversion


class GrapheneDrude:
    """
    Drude model for graphene intraband conductivity.
    
    The conductivity is given by:
        σ(ω) = (e² E_F) / (π ℏ²) × i / (ω + i/τ)
    
    Parameters
    ----------
    fermi_energy : float
        Fermi energy in eV (typical: 0.1 - 1.0 eV)
    relaxation_time : float
        Carrier relaxation time in seconds (typical: 10-1000 fs)
    
    Attributes
    ----------
    E_F : float
        Fermi energy in Joules
    tau : float
        Relaxation time in seconds
    sigma_0 : float
        DC conductivity prefactor
    
    Examples
    --------
    >>> graphene = GrapheneDrude(fermi_energy=0.4, relaxation_time=100e-15)
    >>> freq = 1e12  # 1 THz
    >>> sigma = graphene.conductivity(freq)
    >>> print(f"σ = {sigma:.2e} S")
    """
    
    def __init__(self, fermi_energy: float = 0.4, relaxation_time: float = 100e-15):
        """
        Initialize graphene Drude model.
        
        Parameters
        ----------
        fermi_energy : float
            Fermi energy in eV
        relaxation_time : float
            Relaxation time in seconds
        """
        self.fermi_energy_eV = fermi_energy
        self.E_F = fermi_energy * EV_TO_JOULE  # Convert to Joules
        self.tau = relaxation_time
        
        # Precompute DC conductivity prefactor: e² E_F / (π ℏ²)
        self.sigma_0 = (E_CHARGE**2 * self.E_F) / (np.pi * HBAR**2)
    
    def conductivity(self, frequency: float | np.ndarray) -> complex | np.ndarray:
        """
        Calculate complex conductivity at given frequency.
        
        Parameters
        ----------
        frequency : float or array
            Frequency in Hz
        
        Returns
        -------
        sigma : complex or array
            Complex conductivity in Siemens (S)
        """
        omega = 2 * np.pi * frequency
        gamma = 1.0 / self.tau  # Scattering rate
        
        # Drude conductivity: σ = σ₀ × i / (ω + iγ)
        sigma = self.sigma_0 * 1j / (omega + 1j * gamma)
        
        return sigma
    
    def conductivity_real(self, frequency: float | np.ndarray) -> float | np.ndarray:
        """Return real part of conductivity."""
        return np.real(self.conductivity(frequency))
    
    def conductivity_imag(self, frequency: float | np.ndarray) -> float | np.ndarray:
        """Return imaginary part of conductivity."""
        return np.imag(self.conductivity(frequency))
    
    def surface_impedance(self, frequency: float | np.ndarray) -> complex | np.ndarray:
        """
        Calculate surface impedance Z_s = 1/σ.
        
        Parameters
        ----------
        frequency : float or array
            Frequency in Hz
        
        Returns
        -------
        Z_s : complex or array
            Surface impedance in Ohms
        """
        sigma = self.conductivity(frequency)
        return 1.0 / sigma
    
    def plasma_frequency(self) -> float:
        """
        Calculate effective plasma frequency.
        
        Returns
        -------
        f_p : float
            Plasma frequency in Hz
        """
        # ω_p = √(σ₀/τ) in simplified form
        omega_p = np.sqrt(self.sigma_0 / self.tau)
        return omega_p / (2 * np.pi)
    
    def __repr__(self) -> str:
        return (f"GrapheneDrude(E_F={self.fermi_energy_eV} eV, "
                f"τ={self.tau*1e15:.1f} fs)")


def graphene_RTA_analytical(frequency: np.ndarray, 
                            fermi_energy: float = 0.4,
                            relaxation_time: float = 100e-15) -> tuple:
    """
    Calculate R, T, A coefficients analytically for a graphene sheet.
    
    For a thin conductive sheet at normal incidence:
        R = |r|², T = |t|², A = 1 - R - T
    
    where:
        r = -σ Z₀ / (2 + σ Z₀)
        t = 2 / (2 + σ Z₀)
    
    Parameters
    ----------
    frequency : array
        Frequency array in Hz
    fermi_energy : float
        Fermi energy in eV
    relaxation_time : float
        Relaxation time in seconds
    
    Returns
    -------
    R, T, A : arrays
        Reflection, Transmission, Absorption coefficients
    
    Examples
    --------
    >>> freq = np.linspace(0.1e12, 10e12, 200)
    >>> R, T, A = graphene_RTA_analytical(freq, fermi_energy=0.4)
    >>> print(f"Max absorption: {A.max():.1%} at {freq[A.argmax()]/1e12:.2f} THz")
    """
    Z0 = 376.730313668  # Free space impedance [Ohm]
    
    # Create graphene model
    graphene = GrapheneDrude(fermi_energy, relaxation_time)
    sigma = graphene.conductivity(frequency)
    
    # Normalized conductivity
    sigma_norm = sigma * Z0
    
    # Fresnel coefficients for thin sheet
    r = -sigma_norm / (2 + sigma_norm)
    t = 2 / (2 + sigma_norm)
    
    # Power coefficients
    R = np.abs(r)**2
    T = np.abs(t)**2
    A = 1 - R - T
    
    # Ensure physical bounds
    A = np.maximum(A, 0)
    
    return R, T, A


if __name__ == "__main__":
    # Quick test
    import matplotlib.pyplot as plt
    
    freq = np.linspace(0.1e12, 10e12, 500)
    
    # Test different Fermi energies
    fig, axes = plt.subplots(1, 3, figsize=(12, 4))
    
    for E_F in [0.2, 0.4, 0.6, 0.8]:
        R, T, A = graphene_RTA_analytical(freq, fermi_energy=E_F)
        
        axes[0].plot(freq/1e12, R, label=f'E_F={E_F} eV')
        axes[1].plot(freq/1e12, T)
        axes[2].plot(freq/1e12, A)
    
    axes[0].set_ylabel('Reflection R')
    axes[1].set_ylabel('Transmission T')
    axes[2].set_ylabel('Absorption A')
    
    for ax in axes:
        ax.set_xlabel('Frequency (THz)')
        ax.grid(True, alpha=0.3)
        ax.set_xlim(0, 10)
    
    axes[0].legend()
    fig.suptitle('Graphene R, T, A vs Fermi Energy (τ = 100 fs)')
    plt.tight_layout()
    plt.show()
